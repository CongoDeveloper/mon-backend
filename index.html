<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Scolaire Pro - Supervision Totale</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --sick: #9b59b6;
            --purple: #8e44ad;
            --dark: #232f3e;
            --light: #f4f7f6;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #ebedef; color: #333; }
        header { background: var(--primary); color: white; padding: 1rem; text-align: center; border-bottom: 4px solid var(--secondary); }
        
        nav { display: flex; justify-content: center; background: white; padding: 10px; gap: 10px; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 100; }
        nav button { padding: 10px 18px; cursor: pointer; border: none; background: var(--secondary); color: white; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        nav button:hover { opacity: 0.8; }
        .btn-logout { background: var(--danger) !important; }

        .container { max-width: 1250px; margin: 20px auto; padding: 20px; }
        .section { display: none; }
        .active { display: block; }

        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .btn-save { background: var(--success); color: white; border: none; padding: 14px; cursor: pointer; width: 100%; border-radius: 6px; font-weight: bold; font-size: 16px; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
        th { background: #f8f9fa; color: var(--primary); text-transform: uppercase; font-size: 11px; }

        .cond-Excellente { color: var(--success); font-weight: bold; }
        .cond-Bonne { color: var(--secondary); font-weight: bold; }
        .cond-Moyenne { color: var(--warning); font-weight: bold; }
        .cond-Mauvaise { color: var(--danger); font-weight: bold; }

        .badge { padding: 4px 10px; border-radius: 4px; color: white; font-size: 11px; font-weight: bold; display: inline-block; text-align: center; }
        .bg-p { background: var(--success); } .bg-a { background: var(--danger); }
        .bg-r { background: #d39e00; } .bg-m { background: var(--sick); }
        .bg-alert { background: var(--danger); animation: blink 0.8s infinite; }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.3;} 100% {opacity: 1;} }

        .action-container { display: flex; gap: 4px; justify-content: center; }
        .btn-action { border: none; padding: 8px; border-radius: 5px; cursor: pointer; color: white; min-width: 32px; font-size: 14px; }
        .btn-view { background: #607d8b; } .btn-history { background: #34495e; }
        .btn-convoke { background: #e67e22; } .btn-edit { background: #f39c12; }
        .btn-delete { background: var(--danger); }

        .modal-content { background: white; margin: 5% auto; padding: 25px; border-radius: 12px; width: 90%; max-width: 550px; position: relative; max-height: 85vh; overflow-y: auto; }
        .close { position: absolute; right: 20px; top: 15px; font-size: 28px; cursor: pointer; color: #999; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        
        .res-table { width: 100%; margin-top: 10px; font-size: 13px; }
        .res-table th { background: var(--primary); color: white; }
    </style>
</head>
<body>

<header>
    <h1>Plateforme Scolaire Num√©rique</h1>
    <div id="loggedAs" style="font-size: 0.9em; margin-top: 5px; font-style: italic;"></div>
</header>

<nav>
    <button onclick="showSection('home')">üè† Accueil</button>
    <button onclick="showSection('parent')">üë®‚Äçüë©‚Äçüëß Parents</button>
    <button id="navLogin" onclick="showSection('login')">üîê Connexion Staff</button>
    <button id="navStaff" style="display:none;" onclick="showSection('staffPanel')">‚öôÔ∏è Ma Gestion</button>
    <button id="navAdmin" style="display:none;" onclick="showSection('adminPanel')">üëë Super Admin</button>
    <button id="navLogout" style="display:none;" class="btn-logout" onclick="logout()">D√©connexion</button>
</nav>

<div class="container">
    <section id="home" class="section active">
        <h2>√âcoles Partenaires</h2>
        <div id="schoolList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px;">Chargement...</div>
    </section>

    <section id="parent" class="section">
        <div class="card">
            <h2>Suivi de l'√©l√®ve</h2>
            <div class="form-grid">
                <input type="text" id="p_studentName" placeholder="Nom de l'√©l√®ve">
                <input type="text" id="p_parentId" placeholder="Votre ID Parent">
            </div>
            <button class="btn-save" onclick="searchByParent()">Rechercher</button>
        </div>
        <div id="parentResults"></div>
    </section>

    <section id="login" class="section">
        <div class="card" style="max-width:400px; margin:auto; padding: 40px;">
            <h2 style="text-align:center">Espace Professionnel</h2>
            <input type="text" id="log_user" placeholder="Identifiant" style="margin-bottom:10px;">
            <input type="password" id="log_pass" placeholder="Mot de passe">
            <button class="btn-save" onclick="handleLogin()">Se connecter</button>
        </div>
    </section>

    <section id="adminPanel" class="section">
        <div class="card" style="border: 2px solid gold; background: #fffdf5;">
            <h3>üëë Ajouter une √âcole</h3>
            <div class="form-grid">
                <input type="text" id="sch_name" placeholder="Nom de l'√©cole">
                <input type="text" id="sch_img" placeholder="URL Logo">
                <input type="text" id="sch_user" placeholder="Login Staff">
                <input type="text" id="sch_pass" placeholder="Mot de passe Staff">
            </div>
            <button class="btn-save" onclick="addSchool()">Cr√©er l'√©tablissement</button>
        </div>
        <div class="card">
            <h3>üè¢ Gestion des √âtablissements</h3>
            <div id="adminSchoolListView"></div>
        </div>
    </section>

    <section id="staffPanel" class="section">
        <div id="staffSchoolHeader" class="card" style="background: var(--dark); color:white;"></div>
        <div class="card" style="border-left: 5px solid var(--purple);">
            <h3>üì¢ Communiqu√© de l'√©tablissement</h3>
            <textarea id="sch_communique" placeholder="R√©digez un message..." rows="3"></textarea>
            <button class="btn-save" style="margin-top:10px; background: var(--purple);" onclick="saveCommunique()">Mettre √† jour le communiqu√©</button>
        </div>
        <div class="card">
            <h3>Inscrire un nouvel √©l√®ve</h3>
            <div class="form-grid">
                <input type="text" id="s_name" placeholder="Nom complet">
                <input type="text" id="s_id" placeholder="ID √âl√®ve">
                <input type="text" id="s_parentId" placeholder="ID Parent">
                <select id="s_class">
                    <option value="1">1√®re Ann√©e</option><option value="2">2√®me Ann√©e</option>
                    <option value="3">3√®me Ann√©e</option><option value="4">4√®me Ann√©e</option>
                    <option value="5">5√®me Ann√©e</option><option value="6">6√®me Ann√©e</option>
                </select>
            </div>
            <button class="btn-save" onclick="saveNewStudent()">Ajouter l'√©l√®ve</button>
        </div>
        <div id="staffClassLists"></div>
    </section>
</div>

<!-- MODALS -->
<div id="editSchoolModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('editSchoolModal')">&times;</span><h2>Modifier √âcole</h2><input type="hidden" id="editSchIndex"><input type="text" id="edit_schName" style="margin-bottom:15px;"><input type="text" id="edit_schUser" style="margin-bottom:15px;"><input type="text" id="edit_schPass" style="margin-bottom:15px;"><button class="btn-save" onclick="saveEditedSchool()">Mettre √† jour</button></div></div>
<div id="historyModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('historyModal')">&times;</span><h2 id="historyTitle"></h2><hr><div id="historyList"></div></div></div>
<div id="viewModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('viewModal')">&times;</span><h2 id="viewTitle"></h2><hr><div id="viewDetails"></div></div></div>
<div id="editModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('editModal')">&times;</span><h2>Modifier √âl√®ve</h2><input type="hidden" id="editIndex"><input type="text" id="edit_name" style="margin-bottom:15px;"><input type="number" id="edit_p1" placeholder="P1 %"><input type="number" id="edit_p2" placeholder="P2 %"><input type="number" id="edit_p3" placeholder="P3 %"><input type="number" id="edit_p4" placeholder="P4 %"><button class="btn-save" onclick="updateStudent()">Sauvegarder</button></div></div>

<script>
    // METTRE ICI L'URL DE VOTRE WEB SERVICE RENDER
    const API_URL = "https://mon-backend-server.onrender.com/api"; 
    
    let schools = [];
    let students = [];
    let currentUser = null;
    const todayISO = new Date().toISOString().split('T')[0];

    // Charger les donn√©es au d√©marrage
    async function loadData() {
        try {
            const res = await fetch(`${API_URL}/data`);
            const data = await res.json();
            schools = data.schools || [];
            students = data.students || [];
            renderHomeSchools();
        } catch (e) { console.error("Erreur serveur", e); }
    }

    // AUTHENTIFICATION
    async function handleLogin() {
        const u = document.getElementById('log_user').value;
        const p = document.getElementById('log_pass').value;

        // Connexion Admin avec le nouveau mot de passe
        if(u === 'admin' && p === 'wilson eliotta mwenda 2003') {
            currentUser = { role: 'ADMIN', name: 'Super Admin' };
            applyLogin();
            return;
        }

        // Connexion Staff via le serveur
        const res = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user: u, pass: p })
        });

        if(res.ok) {
            currentUser = await res.json();
            applyLogin();
        } else {
            alert("Identifiants incorrects");
        }
    }

    function applyLogin() {
        document.getElementById('navLogin').style.display = 'none';
        document.getElementById('navLogout').style.display = 'block';
        document.getElementById('loggedAs').innerText = "Session : " + currentUser.name;
        if(currentUser.role === 'ADMIN') { 
            document.getElementById('navAdmin').style.display = 'block'; 
            showSection('adminPanel'); 
        } else { 
            document.getElementById('navStaff').style.display = 'block'; 
            showSection('staffPanel'); 
        }
    }

    function logout() { location.reload(); }

    async function syncSchools() {
        await fetch(`${API_URL}/schools`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(schools)
        });
    }

    async function syncStudents() {
        await fetch(`${API_URL}/students`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(students)
        });
    }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'home') renderHomeSchools();
        if(id === 'adminPanel') renderAdminSchools();
        if(id === 'staffPanel') renderStaffData();
    }

    // LOGIQUE ADMIN
    async function addSchool() {
        const name = document.getElementById('sch_name').value;
        const img = document.getElementById('sch_img').value || 'https://via.placeholder.com/80';
        const user = document.getElementById('sch_user').value;
        const pass = document.getElementById('sch_pass').value;
        if(!name || !user || !pass) return alert("Champs obligatoires !");
        schools.push({ id: 'SCH-'+Date.now(), name, img, staffUser: user, staffPass: pass, communique: "" });
        await syncSchools();
        renderAdminSchools();
        renderHomeSchools();
    }

    function renderAdminSchools() {
        const container = document.getElementById('adminSchoolListView');
        let html = `<table><tr><th>√âcole</th><th>Total √âl√®ves</th><th>Login</th><th>Action</th></tr>`;
        schools.forEach((s, i) => {
            const count = students.filter(st => st.schoolId === s.id).length;
            html += `<tr><td><b>${s.name}</b></td><td>${count}</td><td>${s.staffUser}</td>
            <td><button class="btn-action btn-edit" onclick="openEditSchoolModal(${i})">üìù</button>
            <button class="btn-action btn-delete" onclick="deleteSchool(${i})">üóëÔ∏è</button></td></tr>`;
        });
        container.innerHTML = html + `</table>`;
    }

    // LOGIQUE STAFF
    function renderStaffData() {
        const school = schools.find(s => s.id === currentUser.schoolId);
        document.getElementById('staffSchoolHeader').innerHTML = `<h2>Gestion : ${school.name}</h2>`;
        document.getElementById('sch_communique').value = school.communique || "";
        const container = document.getElementById('staffClassLists');
        container.innerHTML = "";
        const myStudents = students.filter(s => s.schoolId === currentUser.schoolId);
        
        ["1","2","3","4","5","6"].forEach(cls => {
            const list = myStudents.filter(s => s.className === cls);
            if(list.length > 0) {
                let html = `<div class="card"><h3>Classe ${cls}√® Ann√©e</h3><table><tr><th>√âl√®ve</th><th>Pointage</th><th>Actions</th></tr>`;
                list.forEach(s => {
                    const idx = students.findIndex(st => st.id === s.id);
                    html += `<tr><td><b>${s.name}</b></td>
                    <td><select onchange="updatePres(${idx}, this.value)">
                        <option ${s.presence==='Pr√©sent'?'selected':''}>Pr√©sent</option>
                        <option ${s.presence==='Absent'?'selected':''}>Absent</option>
                    </select></td>
                    <td class="action-container">
                        <button class="btn-action btn-edit" onclick="openEditModal(${idx})">üìù</button>
                    </td></tr>`;
                });
                container.innerHTML += html + `</table></div>`;
            }
        });
    }

    async function updatePres(i, val) {
        students[i].presence = val;
        if(!students[i].history) students[i].history = {};
        students[i].history[todayISO] = val;
        await syncStudents();
    }

    async function saveNewStudent() {
        const name = document.getElementById('s_name').value;
        const id = document.getElementById('s_id').value;
        const pId = document.getElementById('s_parentId').value;
        const cls = document.getElementById('s_class').value;
        students.push({ 
            schoolId: currentUser.schoolId, name, id, parentId: pId, className: cls, 
            presence: "Pr√©sent", points: {p1:0, p2:0, p3:0, p4:0}, history: {[todayISO]: "Pr√©sent"} 
        });
        await syncStudents();
        renderStaffData();
    }

    function searchByParent() {
        const name = document.getElementById('p_studentName').value.toLowerCase();
        const pId = document.getElementById('p_parentId').value;
        const found = students.filter(s => s.parentId === pId && s.name.toLowerCase().includes(name));
        document.getElementById('parentResults').innerHTML = found.map(s => `
            <div class="card"><h3>${s.name}</h3><p>√âtat : ${s.presence}</p></div>
        `).join('') || "Aucun √©l√®ve trouv√©.";
    }

    function renderHomeSchools() {
        document.getElementById('schoolList').innerHTML = schools.map(s => `
            <div class="card" style="text-align:center">
                <img src="${s.img}" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px;">
                <h4>${s.name}</h4>
            </div>
        `).join('');
    }

    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    
    // Charger au d√©but
    loadData();
</script>
</body>
</html>
